name: Strict Assignment Guard

on:
  issue_comment:
    types: [created]
  issues:
    types: [assigned]

permissions:
  issues: write
  pull-requests: read

jobs:
  enforce-one-issue-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Assignment Logic and Workload Check
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const issue = context.payload.issue;
            let assignee = "";
            let isAutoAssign = false;

            // 1. Determine the context (Comment vs. Manual Sidebar Assignment)
            if (context.eventName === 'issue_comment') {
              const commentBody = context.payload.comment.body.toLowerCase();
              const author = context.payload.comment.user.login;
              const intentWords = ["assign", "take", "work", "handle", "pick", "do", "fix", "solve"];
              const selfWords = ["me", "i", "myself"];
              
              const hasIntent = intentWords.some(w => commentBody.includes(w));
              const hasSelf = selfWords.some(w => commentBody.includes(w));

              if (hasIntent && hasSelf) {
                assignee = author;
                isAutoAssign = true;
              } else {
                return; // Not an assignment request
              }
            } else if (context.eventName === 'issues' && context.payload.action === 'assigned') {
              assignee = context.payload.assignee.login;
            }

            // 2. Bypass for Bots and Maintainers
            const maintainers = ["nem-web", "adi271001", "Suvam-paul145"];
            if (assignee.endsWith('[bot]') || assignee === 'copilot' || maintainers.includes(assignee)) {
              console.log(`Bypassing check for bot/maintainer: ${assignee}`);
              return;
            }

            // 3. Status Check: Is the issue "On Hold"?
            const isHold = issue.labels.some(label => label.name.toLowerCase() === 'on-hold');
            if (isHold) {
              await github.rest.issues.createComment({
                ...repo,
                issue_number: issue.number,
                body: `â³ **Assignment Paused**\n\n@${assignee}, this issue is currently **on-hold**. Please wait until the label is removed.`
              });
              if (!isAutoAssign) {
                await github.rest.issues.removeAssignees({ ...repo, issue_number: issue.number, assignees: [assignee] });
              }
              return;
            }

            // 4. Workload Check: Strict "One Issue" Rule
            const assignedIssues = await github.paginate(github.rest.issues.listForRepo, {
              ...repo,
              state: 'open',
              assignee: assignee
            });

            // Filter out the current issue to see if they are holding others
            const otherIssues = assignedIssues.filter(i => i.number !== issue.number && !i.pull_request);

            if (otherIssues.length > 0) {
              // PR Exception Check: Do they have any OPEN PRs?
              const { data: prSearch } = await github.rest.search.issuesAndPullRequests({
                q: `is:pr is:open author:${assignee} repo:${repo.owner}/${repo.repo}`
              });

              if (prSearch.total_count === 0) {
                const issueLinks = otherIssues.map(i => `#${i.number}`).join(', ');
                
                await github.rest.issues.createComment({
                  ...repo,
                  issue_number: issue.number,
                  body: `ðŸš« **Assignment Blocked**\n\n@${assignee}, you are already assigned to **${otherIssues.length} other open issue(s)** (${issueLinks}) and have **no open Pull Requests**.\n\n**Rule:** You can only work on **one issue at a time** unless you have submitted a PR for your current task. Please finish your previous work first! ðŸš€`
                });

                // Undo assignment if it was manual or block it if it was auto
                await github.rest.issues.removeAssignees({
                  ...repo,
                  issue_number: issue.number,
                  assignees: [assignee]
                });
                return;
              }
              console.log(`Exception granted: @${assignee} has open PRs.`);
            }

            // 5. Finalize Auto-Assignment (if applicable)
            if (isAutoAssign) {
              await github.rest.issues.addAssignees({
                ...repo,
                issue_number: issue.number,
                assignees: [assignee]
              });
              
              await github.rest.issues.createComment({
                ...repo,
                issue_number: issue.number,
                body: `âœ… **Assigned to @${assignee}**\n\nAll the best! Feel free to share progress updates here.`
              });
            }
