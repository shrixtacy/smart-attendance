name: PR Welcome & Triage

# ðŸš€ Use 'pull_request_target' to safely handle Fork PRs with permissions
on:
  pull_request_target:
    types: [opened]

# ðŸš€ Grant write permission to post comments
permissions:
  pull-requests: write
  issues: write

jobs:
  welcome-message:
    runs-on: ubuntu-latest
    steps:
      - name: Post Welcome Comment
        uses: actions/github-script@v7
        with:
          script: |
            // Get the user and their association with the repo
            const creator = context.payload.pull_request.user.login;
            const association = context.payload.pull_request.author_association;
            
            console.log(`User: ${creator}, Association: ${association}`);

            // 1. Define the Common Instruction (Copilot)
            const copilotInstruction = `
            ---
            ### ðŸ¤– **Action Required: Check Copilot Reviews**
            
            Our AI reviewer (Copilot) may have left comments or suggestions on your code.
            
            ðŸ‘‰ **Please check the automated review.** If any changes are requested or improvements are suggested, kindly update your PR.
            `;

            // 2. Define the Specific Greetings
            const newContributorGreeting = `
            ## ðŸ‘‹ Welcome, @${creator}!
            
            Thanks for opening your **first Pull Request**! ðŸŽ‰
            We are excited to have you here. Please make sure you've read our [Contributing Guidelines](CONTRIBUTING.md).
            `;

            const recurringContributorGreeting = `
            ## ðŸš€ Welcome back, @${creator}!
            
            Great to see you again! Thanks for another contribution.
            `;

            // 3. Logic to choose the greeting
            // Associations for new users: 'FIRST_TIMER', 'FIRST_TIME_CONTRIBUTOR', 'NONE'
            // Associations for recurring: 'CONTRIBUTOR', 'COLLABORATOR', 'MEMBER', 'OWNER'
            
            let finalMessage = '';
            
            // recurring contributors
            if (['COLLABORATOR', 'MEMBER', 'OWNER', 'CONTRIBUTOR'].includes(association)) {
              finalMessage = recurringContributorGreeting + copilotInstruction;
            } 
            // new contributors
            else {
              finalMessage = newContributorGreeting + copilotInstruction;
            }

            // 4. Post the comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: finalMessage
            });
