name: Limit Assigned Issues

on:
  issues:
    types: [assigned]

permissions:
  issues: write

jobs:
  check-workload:
    runs-on: ubuntu-latest
    steps:
      - name: Check User Workload
        uses: actions/github-script@v7
        with:
          script: |
            const assignee = context.payload.assignee.login;
            const currentIssueNumber = context.issue.number;
            const repo = context.repo;

            // ğŸ¤– 1. BOT BYPASS (Fixes the Error)
            // If the assignee is Copilot or any other bot, stop the script immediately.
            if (assignee === 'copilot' || assignee.endsWith('[bot]')) {
              console.log(`ğŸ¤– Assignee is a bot/AI (${assignee}). Skipping workload checks.`);
              return;
            }

            console.log(`Checking workload for @${assignee}...`);

            // 2. Fetch all OPEN issues assigned to this user
            // We use a try-catch block to handle API errors gracefully just in case
            try {
              const assignedIssues = await github.paginate(github.rest.issues.listForRepo, {
                ...repo,
                state: 'open',
                assignee: assignee
              });

              // 3. Filter out the current issue
              const otherIssues = assignedIssues.filter(i => i.number !== currentIssueNumber && !i.pull_request);

              // 4. Logic: Check if user has other issues
              if (otherIssues.length > 0) {
                
                // Search for OPEN PRs created by this user
                const { data: prSearch } = await github.rest.search.issuesAndPullRequests({
                  q: `is:pr is:open author:${assignee} repo:${repo.owner}/${repo.repo}`
                });

                // Exception: If they have open PRs, allow assignment
                if (prSearch.total_count > 0) {
                  console.log(`âœ… Exception granted: @${assignee} has pending PRs.`);
                  return; 
                }

                // Violation: Too many issues + No PRs
                const issueLinks = otherIssues.map(i => `#${i.number}`).join(', ');
                console.log(`âš ï¸ Violation: User has ${otherIssues.length} other issues.`);

                // Post Warning
                await github.rest.issues.createComment({
                  ...repo,
                  issue_number: currentIssueNumber,
                  body: `ğŸš« **Assignment Blocked**
                  
                  @${assignee} is already assigned to **${otherIssues.length} other open issue(s)** (${issueLinks}) and has **no open Pull Requests**.
                  
                  **Policy:** You cannot take a new issue while holding others without submitting code.
                  ğŸ‘‰ Please submit a PR for your current issue first.`
                });

                // Unassign User
                await github.rest.issues.removeAssignees({
                  ...repo,
                  issue_number: currentIssueNumber,
                  assignees: [assignee]
                });
              } else {
                console.log("âœ… User is clear. Assignment allowed.");
              }

            } catch (error) {
              console.log(`âš ï¸ Error checking workload: ${error.message}`);
              // Do not fail the workflow if the API hiccups
            }
