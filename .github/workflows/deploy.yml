name: CI/CD Pipeline (Vercel & Render)

on:
  push:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  # ==========================================
  # üü° STAGING DEPLOYMENT (Triggered on Push)
  # ==========================================
  deploy-staging:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: üöÄ Deploy Frontend to Vercel (Preview/Staging)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          # If your frontend is in a subfolder, uncomment and set this:
          # working-directory: ./frontend
          github-comment: true

      - name: ‚öôÔ∏è Trigger Backend Staging Deploy on Render
        run: |
          echo "Triggering Render Backend Webhook..."
          curl -X POST "${{ secrets.RENDER_BACKEND_DEPLOY_HOOK_STAGING }}"

      - name: üß† Trigger ML Service Staging Deploy on Render
        run: |
          echo "Triggering Render ML Service Webhook..."
          curl -X POST "${{ secrets.RENDER_ML_DEPLOY_HOOK_STAGING }}"

  # ==========================================
  # üü¢ PRODUCTION DEPLOYMENT (Triggered on Release)
  # ==========================================
  deploy-production:
    if: github.event_name == 'release' && github.event.action == 'published'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: üöÄ Deploy Frontend to Vercel (Production)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod' # This flag forces a production build
          # working-directory: ./frontend
          github-comment: false

      - name: ‚öôÔ∏è Trigger Backend Production Deploy on Render
        run: |
          echo "Triggering Render Backend Webhook..."
          curl -X POST "${{ secrets.RENDER_BACKEND_DEPLOY_HOOK_PROD }}"

      - name: üß† Trigger ML Service Production Deploy on Render
        run: |
          echo "Triggering Render ML Service Webhook..."
          curl -X POST "${{ secrets.RENDER_ML_DEPLOY_HOOK_PROD }}"
