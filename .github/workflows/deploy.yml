name: CI/CD Pipeline (Vercel & Render)

on:
  push:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  # ==========================================
  # üü° STAGING DEPLOYMENT (Triggered on Push)
  # ==========================================
  deploy-staging:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Detect which folders had code changes
      - name: üîç Check for changed files
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'server/backend-api/**'
            ml:
              - 'server/ml-service/**'
      
      # 2. Deploy Frontend ONLY if 'frontend' changed
      - name: üöÄ Deploy Frontend to Vercel (Preview/Staging)
        if: steps.changes.outputs.frontend == 'true'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
          github-comment: true

      # 3. Deploy Backend ONLY if 'server/backend-api' changed
      - name: ‚öôÔ∏è Trigger Backend API Staging Deploy on Render
        if: steps.changes.outputs.backend == 'true'
        run: |
          echo "Changes detected in backend-api. Triggering Render Staging Webhook..."
          curl -X POST "${{ secrets.RENDER_BACKEND_DEPLOY_HOOK_STAGING }}"

      # 4. Deploy ML Service ONLY if 'server/ml-service' changed
      - name: üß† Trigger ML Service Staging Deploy on Render
        if: steps.changes.outputs.ml == 'true'
        run: |
          echo "Changes detected in ml-service. Triggering Render Staging Webhook..."
          curl -X POST "${{ secrets.RENDER_ML_DEPLOY_HOOK_STAGING }}"

  # ==========================================
  # üü¢ PRODUCTION DEPLOYMENT (Triggered on Release)
  # ==========================================
  deploy-production:
    if: github.event_name == 'release' && github.event.action == 'published'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: üîç Check for changed files
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'server/backend-api/**'
            ml:
              - 'server/ml-service/**'
      
      - name: üöÄ Deploy Frontend to Vercel (Production)
        if: steps.changes.outputs.frontend == 'true'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./frontend
          github-comment: false

      - name: ‚öôÔ∏è Trigger Backend API Production Deploy on Render
        if: steps.changes.outputs.backend == 'true'
        run: |
          echo "Changes detected in backend-api. Triggering Render Production Webhook..."
          curl -X POST "${{ secrets.RENDER_BACKEND_DEPLOY_HOOK_PROD }}"

      - name: üß† Trigger ML Service Production Deploy on Render
        if: steps.changes.outputs.ml == 'true'
        run: |
          echo "Changes detected in ml-service. Triggering Render Production Webhook..."
          curl -X POST "${{ secrets.RENDER_ML_DEPLOY_HOOK_PROD }}"
